# MoeDesk 开发计划

## 项目概述

MoeDesk 是一个二次元跨境电商社媒运营工作台，核心功能包括统一管理多平台消息、AI 辅助内容生成、工作流自动化。

---

## 功能模块进度

| 模块 | 路由 | 状态 | 关联 SOP |
|-----|------|------|---------|
| 用户认证 | `/login` | ✅ 已完成 | - |
| 用户管理 | `/admin/users` | ✅ 已完成 | - |
| **工作流配置** | `/workflows` | ✅ 已完成 | 全部 |
| 消息中心 | `/inbox` | ⏳ 待开发 | SOP-08, 09, 10 |
| 热点雷达 | `/trending` | ⏳ 待开发 | SOP-01, 02, 03 |
| 内容日历 | `/content` | ⏳ 待开发 | SOP-04, 05, 06, 12 |
| 内容审核 | `/review` | ⏳ 待开发 | SOP-04, 05 |
| 数据报表 | `/analytics` | ⏳ 待开发 | SOP-07, 11, 13 |

---

## 已完成模块

### 1. 用户认证系统
- JWT + Session 认证
- 登录/登出功能
- 路由保护中间件

### 2. 用户管理 (`/admin/users`)
- 用户 CRUD 操作
- 角色管理 (ADMIN/OPERATOR)
- 账号启用/禁用
- 密码重置

### 3. 工作流配置 (`/workflows`) - 2025-12-24 完成

**功能清单**：
- [x] 20 个 SOP 工作流静态配置
- [x] 按阶段分组展示（内容生产/分发/互动/转化）
- [x] 统计概览卡片（活跃/停用/错误/今日执行/成功率）
- [x] 工作流列表表格
- [x] 执行日志弹窗
- [x] 跳转 n8n 编辑器入口
- [x] API Schema 使用 zod 定义并验证

**20 个 SOP 工作流**：

| 阶段 | SOP | 工作流名称 | 触发方式 |
|------|-----|-----------|---------|
| 内容生产 | SOP-01 | AniList 新番同步 | 定时 |
| 内容生产 | SOP-01 | ANN RSS 订阅 | 定时 |
| 内容生产 | SOP-02 | Reddit 热帖抓取 | 定时 |
| 内容生产 | SOP-02 | Twitter 话题监控 | 定时 |
| 内容生产 | SOP-03 | 选题评分计算 | Webhook |
| 内容生产 | SOP-04 | AI 内容生成 | Webhook |
| 内容生产 | SOP-05 | 多平台适配 | Webhook |
| 内容分发 | SOP-06 | 定时发布 | 定时 |
| 内容分发 | SOP-06 | 跨平台同步 | Webhook |
| 内容分发 | SOP-07 | 数据回收 | 定时 |
| 用户互动 | SOP-08 | 消息聚合 | 定时 |
| 用户互动 | SOP-09 | 消息分类 | Webhook |
| 用户互动 | SOP-10 | 自动回复 | Webhook |
| 用户互动 | SOP-10 | 人工回复同步 | Webhook |
| 用户互动 | SOP-11 | 粉丝标签 | 定时 |
| 转化闭环 | SOP-12 | 商品关联 | Webhook |
| 转化闭环 | SOP-12 | 购买链接生成 | Webhook |
| 转化闭环 | SOP-13 | 转化追踪 | 定时 |
| 转化闭环 | SOP-13 | 归因分析 | 定时 |
| 转化闭环 | SOP-13 | 周报生成 | 定时 |

**新增文件**：

| 文件路径 | 类型 | 说明 |
|---------|------|------|
| `types/workflow.ts` | 类型 | 工作流相关类型定义 |
| `lib/n8n.ts` | 服务 | n8n API 封装 + SOP 配置 |
| `app/api/workflows/schema.ts` | Schema | Zod 验证规则 |
| `app/api/workflows/route.ts` | API | 工作流列表接口 |
| `app/api/workflows/[id]/executions/route.ts` | API | 执行日志接口 |
| `components/workflows/workflow-status-badge.tsx` | Server | 状态徽章组件 |
| `components/workflows/workflow-stats.tsx` | Server | 统计卡片组件 |
| `components/workflows/execution-log-dialog.tsx` | Client | 执行日志弹窗 |
| `components/workflows/workflow-table.tsx` | Client | 工作流表格 |
| `components/workflows/workflow-phase-tabs.tsx` | Client | 阶段标签页 |

**API Schema 定义** (符合全栈编码规范)：

```typescript
// app/api/workflows/schema.ts
export const WorkflowListReq = z.object({
  phase: z.enum([...]).optional(),
})

export const ExecutionListReq = z.object({
  limit: z.coerce.number().min(1).max(100).default(20),
  status: z.enum(["success", "error", "running", "waiting"]).optional(),
})
```

Route Handler 使用 `safeParse` 验证请求参数，返回格式统一为 `{ data }` 或 `{ error, details }`。

**修改文件**：
```
app/(dashboard)/workflows/page.tsx   # 页面重写 (Server Component)
.env                                 # 添加 N8N_WEBHOOK_URL, N8N_API_KEY
```

---

## 待开发模块

### 消息中心 (`/inbox`)
统一聚合多平台消息，AI 自动分类，快捷回复。

### 热点雷达 (`/trending`)
新番日历、Reddit 热度排行、选题决策。

### 内容日历 (`/content`)
日/周/月视图排期、内容创建、平台预览。

### 内容审核 (`/review`)
待审核队列、平台适配检查、批量操作。

### 数据报表 (`/analytics`)
内容表现、渠道分析、KOC 管理、归因报表。

---

## 技术栈

- **前端**：Next.js 16 + React 19 + TypeScript + Tailwind CSS v4 + shadcn/ui
- **数据库**：PostgreSQL + Prisma ORM
- **工作流**：n8n (Docker 部署)
- **认证**：JWT + Session

---

## 环境配置

```env
DATABASE_URL="postgresql://postgres:postgres@localhost:15432/moedesk"
JWT_SECRET="your-secret-key"
N8N_WEBHOOK_URL="http://localhost:5678"
N8N_API_KEY=""
```

---

## 开发规范

遵守 `全栈编码规范.md`，主要包括：
- 禁止原生 HTML 交互元素，使用 shadcn/ui
- 禁止硬编码颜色，使用语义化 Tailwind class
- 禁止 any 类型
- 优先 Server Component
- Route Handler params 使用 `await context.params`
