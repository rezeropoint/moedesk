# MoeDesk 开发计划

## 项目概述

MoeDesk 是一个二次元跨境电商社媒运营工作台，核心功能：统一管理多平台消息、AI 辅助内容生成、工作流自动化。

---

## 功能模块进度

| 模块 | 路由 | 状态 |
|-----|------|------|
| 用户认证 | `/login` | ✅ 已完成 |
| 用户管理 | `/admin/users` | ✅ 已完成 |
| 工作流配置 | `/workflows` | ✅ 已完成 |
| **热点雷达** | `/trending` | ✅ 已完成 |
| 消息中心 | `/inbox` | ⏳ 待开发 |
| 内容日历 | `/content` | ⏳ 待开发 |
| 数据报表 | `/analytics` | ⏳ 待开发 |

---

## 数据模型

### 核心表

| 表名 | 说明 | 关键字段 |
|------|------|---------|
| `series` | IP 系列（如：鬼灭之刃整体） | type, titleOriginal, aggregatedScore |
| `entries` | IP 条目（单季/单作品） | seriesId, totalScore, status |
| `trendings` | 热度追踪（关联系列） | seriesId, redditKarma, googleTrend |
| `trending_history` | 热度历史（TimescaleDB） | trendingId, source, popularity |

### 关系设计

```
Series (系列)
  ├── Entry[] (多个季度/作品)
  └── Trending (系列级热度追踪)
        └── TrendingHistory[] (时序数据)
```

### 枚举类型

| 枚举 | 值 |
|------|-----|
| `IpType` | ANIME, GAME, MANGA, LIGHT_NOVEL, VTUBER, MOVIE, OTHER |
| `ReviewStatus` | PENDING, APPROVED, REJECTED |
| `TrendingStatus` | WATCHING, FOCUSED, IN_PROGRESS, ARCHIVED |
| `TrendingSource` | GOOGLE_TRENDS, REDDIT, TWITTER, BILIBILI, ANILIST |

---

## API 路由

| 路径 | 方法 | 说明 |
|------|------|------|
| `/api/series` | GET/POST | 系列列表/创建 |
| `/api/series/search` | GET | 系列搜索 |
| `/api/series/[id]` | GET/PATCH/DELETE | 系列详情/更新/删除 |
| `/api/entries` | GET | 条目列表 |
| `/api/entries/[id]` | GET/PATCH | 条目详情/更新 |
| `/api/entries/[id]/approve` | POST | 审核通过 |
| `/api/entries/[id]/reject` | POST | 审核拒绝 |
| `/api/trendings` | GET | 热度列表 |
| `/api/trendings/surge` | GET | 热度飙升 |
| `/api/configs/[key]` | GET/PUT | 配置读写 |
| `/api/workflows` | GET | 工作流列表 |
| `/api/workflows/[id]/toggle` | PATCH | 切换工作流启用状态 |

---

## 监测设置面板 - 2025-12-29 完成

热点雷达右侧的"监测设置"卡片，用于控制 n8n 工作流的启用/禁用。

### 功能清单

- [x] 显示热点监测相关工作流（AniList/Reddit/Google Trends）
- [x] 每个工作流显示：名称、触发时间、状态开关、编辑链接
- [x] 开关调用 n8n API `/activate` 和 `/deactivate` 端点
- [x] 编辑按钮跳转 n8n 编辑器
- [x] 未配置的工作流显示"未配置"徽章，开关禁用
- [x] 权限控制：仅 ADMIN 角色可操作

### 新增/修改文件

| 文件 | 操作 | 说明 |
|------|------|------|
| `components/ui/switch.tsx` | 新增 | shadcn/ui Switch 组件 |
| `lib/n8n.ts` | 修改 | 新增 `toggleN8NWorkflow` 函数 |
| `app/api/workflows/[id]/toggle/schema.ts` | 新增 | API Schema |
| `app/api/workflows/[id]/toggle/route.ts` | 新增 | 切换工作流状态 API |
| `components/trending/monitor-settings-panel.tsx` | 重写 | 监测设置面板组件 |
| `.env` | 修改 | 添加 `NEXT_PUBLIC_N8N_URL` |

### 使用前提

确保 `N8N_API_KEY` 已在 `.env` 中配置，否则工作流将显示为"未配置"状态。

---

## n8n 工作流

| 文件 | 触发方式 | 功能 |
|------|---------|------|
| `sop-01-anilist-sync.json` | 每周一 09:00 | AniList 新番同步 → entries |
| `sop-02-popularity-refresh.json` | 每天 03:00 | 热度全量刷新 |
| `sop-02-google-trends.json` | 每天 04:00 | Google Trends 采集 |
| `sop-02-reddit-monitor.json` | 每天 05:00 | Reddit Karma 采集 |

### 审核流程

```
n8n 同步 → entries (PENDING)
              │
              ▼
         人工审核
              │
    ┌─────────┴─────────┐
    ▼                   ▼
  通过                 拒绝
    │
    ▼
选择/创建 Series + 创建 Trending
    │
    ▼
实时热点显示
```

---

## 技术栈

- **前端**：Next.js 16 + React 19 + TypeScript + Tailwind CSS v4 + shadcn/ui
- **数据库**：TimescaleDB + Prisma ORM
- **工作流**：n8n (Docker)
- **认证**：JWT + Session

---

## 环境配置

```env
DATABASE_URL="postgresql://postgres:postgres@localhost:15432/moedesk"
JWT_SECRET="your-secret-key"
N8N_WEBHOOK_URL="http://localhost:5678"
N8N_API_KEY=""                              # n8n API Key（工作流控制必需）
NEXT_PUBLIC_N8N_URL="http://localhost:5678" # 客户端可访问的 n8n 地址
```

---

## 开发规范

遵守 `全栈编码规范.md`：
- shadcn/ui 组件优先
- 语义化 Tailwind class
- TypeScript 严格模式
- Server Component 优先
