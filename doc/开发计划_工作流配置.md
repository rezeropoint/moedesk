# MoeDesk 开发计划

## 项目概述

MoeDesk 是一个二次元跨境电商社媒运营工作台，核心功能：统一管理多平台消息、AI 辅助内容生成、工作流自动化。

---

## 功能模块进度

| 模块 | 路由 | 状态 |
|-----|------|------|
| 用户认证 | `/login` | ✅ 已完成 |
| 用户管理 | `/admin/users` | ✅ 已完成 |
| 工作流配置 | `/workflows` | ✅ 已完成 |
| **热点雷达** | `/trending` | ✅ 已完成 |
| **热度分析** | `/trending/analytics` | ✅ 已完成 |
| 消息中心 | `/inbox` | ⏳ 待开发 |
| 内容日历 | `/content` | ⏳ 待开发 |
| 数据报表 | `/analytics` | ⏳ 待开发 |

---

## 数据模型

### 核心表

| 表名 | 说明 | 关键字段 |
|------|------|---------|
| `series` | IP 系列（如：鬼灭之刃整体） | type, titleOriginal, aggregatedScore |
| `entries` | IP 条目（单季/单作品） | seriesId, totalScore, status |
| `trendings` | 热度追踪（关联系列） | seriesId, redditKarma, googleTrend |
| `trending_history` | 热度历史（TimescaleDB） | trendingId, source, popularity |

### 关系设计

```
Series (系列)
  ├── Entry[] (多个季度/作品)
  └── Trending (系列级热度追踪)
        └── TrendingHistory[] (时序数据)
```

### 枚举类型

| 枚举 | 值 |
|------|-----|
| `IpType` | ANIME, GAME, MANGA, LIGHT_NOVEL, VTUBER, MOVIE, OTHER |
| `ReviewStatus` | PENDING, APPROVED, REJECTED |
| `TrendingStatus` | WATCHING, FOCUSED, IN_PROGRESS, ARCHIVED |
| `TrendingSource` | GOOGLE_TRENDS, REDDIT, TWITTER, BILIBILI, ANILIST |

---

## API 路由

| 路径 | 方法 | 说明 |
|------|------|------|
| `/api/series` | GET/POST | 系列列表/创建 |
| `/api/series/search` | GET | 系列搜索 |
| `/api/series/[id]` | GET/PATCH/DELETE | 系列详情/更新/删除 |
| `/api/entries` | GET | 条目列表 |
| `/api/entries/[id]` | GET/PATCH | 条目详情/更新 |
| `/api/entries/[id]/approve` | POST | 审核通过 |
| `/api/entries/[id]/reject` | POST | 审核拒绝 |
| `/api/entries/[id]/revoke` | POST | 撤销审核（ADMIN） |
| `/api/entries/parse-title` | POST | 标题解析预览 |
| `/api/trendings` | GET | 热度列表 |
| `/api/trendings/surge` | GET | 热度飙升 |
| `/api/trendings/search` | GET | IP 搜索 |
| `/api/trendings/analytics/history` | GET | 历史时序数据 |
| `/api/trendings/analytics/compare` | GET | 变化率对比 |
| `/api/trendings/analytics/sources` | GET | 数据源分析 |
| `/api/configs/[key]` | GET/PUT | 配置读写 |
| `/api/workflows` | GET | 工作流列表 |
| `/api/workflows/[id]/toggle` | PATCH | 切换工作流启用状态 |

---

## 监测设置面板 - 2025-12-29 完成

热点雷达右侧的"监测设置"卡片，用于控制 n8n 工作流的启用/禁用。

### 功能清单

- [x] 显示热点监测相关工作流（AniList/Reddit/Google Trends）
- [x] 每个工作流显示：名称、触发时间、状态开关、编辑链接
- [x] 开关调用 n8n API `/activate` 和 `/deactivate` 端点
- [x] 编辑按钮跳转 n8n 编辑器
- [x] 未配置的工作流显示"未配置"徽章，开关禁用
- [x] 权限控制：仅 ADMIN 角色可操作

### 新增/修改文件

| 文件 | 操作 | 说明 |
|------|------|------|
| `components/ui/switch.tsx` | 新增 | shadcn/ui Switch 组件 |
| `lib/n8n.ts` | 修改 | 新增 `toggleN8NWorkflow` 函数 |
| `app/api/workflows/[id]/toggle/schema.ts` | 新增 | API Schema |
| `app/api/workflows/[id]/toggle/route.ts` | 新增 | 切换工作流状态 API |
| `components/trending/monitor-settings-panel.tsx` | 重写 | 监测设置面板组件 |
| `.env` | 修改 | 添加 `NEXT_PUBLIC_N8N_URL` |

### 使用前提

确保 `N8N_API_KEY` 已在 `.env` 中配置，否则工作流将显示为"未配置"状态。

---

## n8n 工作流

| 文件 | 触发方式 | 功能 |
|------|---------|------|
| `sop-01-anilist-sync.json` | 每周一 09:00 | AniList 新番同步 → entries |
| `sop-02-popularity-refresh.json` | 每天 03:00 | 热度全量刷新 |
| `sop-02-google-trends.json` | 每天 04:00 | Google Trends 采集 |
| `sop-02-reddit-monitor.json` | 每天 05:00 | Reddit Karma 采集 |

### 审核流程

```
n8n 同步 → entries (PENDING)
              │
              ▼
         人工审核
              │
    ┌─────────┴─────────┐
    ▼                   ▼
  通过                 拒绝
    │
    ▼
选择/创建 Series + 创建 Trending
    │
    ▼
实时热点显示
```

---

## 技术栈

- **前端**：Next.js 16 + React 19 + TypeScript + Tailwind CSS v4 + shadcn/ui
- **数据库**：TimescaleDB + Prisma ORM
- **工作流**：n8n (Docker)
- **认证**：JWT + Session

---

## 环境配置

```env
DATABASE_URL="postgresql://postgres:postgres@localhost:15432/moedesk"
JWT_SECRET="your-secret-key"
N8N_WEBHOOK_URL="http://localhost:5678"
N8N_API_KEY=""                              # n8n API Key（工作流控制必需）
NEXT_PUBLIC_N8N_URL="http://localhost:5678" # 客户端可访问的 n8n 地址
```

---

## 热度分析页面 - 2025-12-29 完成

使用 Recharts 图表库实现的热度数据分析页面。

### 功能清单

- [x] 时序趋势图：多 IP 热度变化曲线（7/30/90天）
- [x] 变化率柱状图：各 IP 变化率对比
- [x] 数据源饼图：贡献度分析
- [x] 关键指标卡片：平均变化率、最热 IP、数据源覆盖
- [x] IP 多选器：搜索添加，最多 5 个
- [x] 数据源切换：综合/Reddit/Google/AniList/Twitter/Bilibili

### 新增文件

| 目录 | 文件数 | 说明 |
|------|--------|------|
| `app/api/trendings/search/` | 2 | IP 搜索 API |
| `app/api/trendings/analytics/` | 6 | 分析 API（history/compare/sources） |
| `components/trending/analytics/` | 8 | 分析页组件 |
| `types/analytics.ts` | 1 | 类型定义 |

---

## 热度分析分层展示改造 - 2025-12-30 完成

解决不同社媒数据源数值维度差异问题（AniList 0-100 vs Bilibili 数百万）。

### 问题背景

| 数据源 | 典型范围 | 原有问题 |
|--------|---------|---------|
| ANILIST rating | 0-100 | 被高数值源淹没 |
| GOOGLE_TRENDS | 0-100 | 被高数值源淹没 |
| REDDIT | 数百～数千 | 中等 |
| TWITTER | 数百～数千 | 中等 |
| BILIBILI | 数千～数百万 | 完全压制其他源 |

### 解决方案

1. **趋势线图改造**
   - 综合模式：各数据源归一化到 0-100 后用面积图展示
   - 单源模式：保持原始值折线图对比

2. **饼图→雷达图**
   - 用活跃度分数（归一化 0-100）替代绝对值
   - 展示各数据源的相对强度
   - 添加数据覆盖率指示器

### 新增/修改文件

| 文件 | 操作 | 说明 |
|------|------|------|
| `lib/normalize.ts` | 新增 | 归一化工具函数 |
| `types/analytics.ts` | 修改 | 新增归一化相关类型 |
| `components/trending/analytics/trend-line-chart.tsx` | 重写 | 综合模式归一化面积图 |
| `components/trending/analytics/source-radar-chart.tsx` | 新增 | 雷达图组件 |
| `components/trending/analytics/analytics-container.tsx` | 修改 | 使用新组件 |

### 归一化算法（已废弃）

原方案使用当前查询数据的 min/max，导致无法跨番剧比较。

---

## 热度分析全局归一化改造 - 2025-12-30 完成

优化归一化算法，使用全局历史数据作为参考范围，实现跨番剧的真实热度比较。

### 问题背景

| 问题 | 描述 |
|------|------|
| 无法跨番剧比较 | 只选一个 IP 时，其 min=0, max=100，无法与其他番剧比较 |
| 时间范围跳变 | 切换 7/30/90 天时，同一数据的归一化值会跳变 |
| AniList 存储问题 | 工作流存储的是原始 popularity 值（0-500,000+），不是归一化值 |

### 数据源存储格式

| 数据源 | 存储值 | 范围 | 备注 |
|--------|--------|------|------|
| GOOGLE_TRENDS | 原值 | 0-100 | Google 官方标准化，无需处理 |
| ANILIST | 原值 | 0-500,000+ | 工作流存储原始 popularity，需归一化 |
| REDDIT | 原值 | 0-50,000+ | 一周内帖子 karma 累计，需归一化 |
| TWITTER | 原值 | 待定 | 未实现 |
| BILIBILI | 原值 | 待定 | 未实现 |

### 解决方案

1. **全局参考范围**
   - 后端 API 查询各数据源的**全部历史最大值**
   - 返回 `globalRanges` 字段供前端使用

2. **归一化策略**
   - 已标准化数据源（仅 GOOGLE_TRENDS）：直接使用原值
   - 其他数据源：使用 `min(value / globalMax * 100, 100)` 归一化

### 归一化公式

```typescript
// 使用全局历史最大值归一化
normalizedValue = min((value / globalMax) * 100, 100)

// globalMax 来自 SQL 查询
SELECT source, MAX(popularity) as max_value
FROM trending_history
WHERE popularity > 0
GROUP BY source
```

### 新增/修改文件

| 文件 | 操作 | 说明 |
|------|------|------|
| `app/api/trendings/analytics/history/route.ts` | 修改 | 查询并返回 globalRanges |
| `types/analytics.ts` | 修改 | 新增 GlobalSourceRange 类型 |
| `lib/normalize.ts` | 修改 | 新增 normalizeWithGlobalRanges 函数 |
| `components/trending/analytics/analytics-container.tsx` | 修改 | 管理 globalRanges 状态 |
| `components/trending/analytics/trend-line-chart.tsx` | 修改 | 使用新归一化函数 |

### 效果

- 番剧 A (Reddit 5000) vs 番剧 B (Reddit 8000) 可在同一坐标系真实比较
- 切换时间范围时归一化值保持稳定
- 突破历史纪录的番剧显示为 100（截断）

---

## 番剧IP和多季功能完善 - 2025-12-30 完成

解决审核流程中 IP 名称和多季关联的问题。

### 问题背景

| 问题 | 描述 |
|------|------|
| 已审核无法修改 | 审核通过后无法修改关联关系或撤销 |
| 多季名称问题 | 先添加"鬼灭之刃 第二季"会创建同名系列 |
| 季度检重缺失 | 同一系列可能出现两个"第2季" |
| 日期显示不准 | 热点列表显示最高分季日期而非最新季 |

### 解决方案

1. **标题解析工具**
   - 从"鬼灭之刃 第二季"提取基础名称"鬼灭之刃"
   - 支持中文季度（第一季）、英文季度（Season 1/S1）、特殊形式（剧场版/OVA）
   - 低置信度时提示用户确认

2. **审核流程优化**
   - 创建新系列时使用基础名称而非完整标题
   - 自动填充 seasonNumber 和 seasonLabel
   - 季度编号检重

3. **已审核修改能力**
   - 撤销审核 API（ADMIN 限制）
   - 修改关联系列和季度
   - 管理条目入口（热点详情弹窗）

### 新增/修改文件

| 文件 | 操作 | 说明 |
|------|------|------|
| `lib/title-parser.ts` | 新增 | 标题解析工具函数 |
| `app/api/entries/[id]/revoke/route.ts` | 新增 | 撤销审核 API |
| `app/api/entries/parse-title/route.ts` | 新增 | 标题解析预览 API |
| `components/trending/series-entries-manager.tsx` | 新增 | 系列条目管理器 |
| `components/ui/alert-dialog.tsx` | 新增 | shadcn 确认弹窗 |
| `app/api/entries/schema.ts` | 修改 | 扩展 ApproveReq/UpdateReq |
| `app/api/entries/[id]/approve/route.ts` | 修改 | 集成名称解析和检重 |
| `app/api/entries/[id]/route.ts` | 修改 | 扩展 PATCH 支持关联修改 |
| `app/api/trendings/route.ts` | 修改 | 日期按最新季显示 |
| `components/trending/entry-item.tsx` | 修改 | 审批弹窗添加系列名称编辑 |
| `components/trending/trending-item.tsx` | 修改 | 添加管理条目入口 |

### 操作路径

```
热点雷达 → 点击"详情" → 管理条目按钮
  ├── 查看系列下所有已审核 Entry
  ├── ⚙️ 编辑（修改系列/季度）
  └── ↩️ 撤销审核（重置为待审核）
```

---

## 热点雷达 UI 层级优化 - 2025-12-30 完成

优化热点列表的系列与季度展示方式，清晰表达数据粒度。

### 问题背景

| 问题 | 描述 |
|------|------|
| 层级不清 | 直接展示系列级数据，未体现系列→季度的层级关系 |
| 粒度混淆 | 社媒数据是系列级，AniList 数据可区分季度，但 UI 无区分 |

### 解决方案

1. **展开/折叠层级**
   - 系列主行左侧添加展开按钮（▶/▼）
   - 点击展开后显示该系列所有已审核的季度数据
   - 有多季时在标题旁显示「X 季」徽章

2. **数据粒度标注**
   - 第三行 AniList 数据旁显示「系列级」标签
   - 第四行社媒热度旁显示「系列级」标签
   - 展开的季度行显示「季度级」标签
   - 详情弹窗各区块也有相应标注

### 数据粒度说明

| 数据源 | 粒度 | 说明 |
|-------|-----|------|
| Reddit Karma | 系列级 | 搜索关键词匹配整个系列 |
| Google Trends | 系列级 | 搜索关键词匹配整个系列 |
| Twitter/X | 系列级 | 搜索关键词匹配整个系列 |
| B站弹幕 | 系列级 | 搜索关键词匹配整个系列 |
| AniList 热度/评分 | 季度级 | 每个 Entry 有独立数据 |
| 系列综合分 | 系列级 | 聚合计算 |

### 新增/修改文件

| 文件 | 操作 | 说明 |
|------|------|------|
| `types/trending.ts` | 修改 | 添加 SeasonEntry 类型，TrendingListItem 新增 entries |
| `app/api/trendings/route.ts` | 修改 | 获取所有 APPROVED 季度数据 |
| `app/(dashboard)/trending/page.tsx` | 修改 | 同步服务端查询逻辑 |
| `components/trending/data-level-badge.tsx` | 新增 | 数据粒度标签组件 |
| `components/trending/season-entry-row.tsx` | 新增 | 季度行组件 |
| `components/trending/trending-item.tsx` | 重构 | 添加展开/折叠功能和粒度标签 |

### UI 交互示意

```
┌──────────────────────────────────────────────────────────────────┐
│ ▶ │ 1 │ 封面 │ 标题 + IP类型 + [3季]                    │ 详情 │
│   │   │      │ 中文标题                                  │ 生成 │
│   │   │      │ [系列级] AniList 综合分 热度 评分         │      │
│   │   │      │ [系列级] Reddit X Google B站              │      │
└──────────────────────────────────────────────────────────────────┘
                              ↓ 点击展开
┌──────────────────────────────────────────────────────────────────┐
│ ▼ │ 1 │ 封面 │ ...（同上）                                      │
├──────────────────────────────────────────────────────────────────┤
│       │ 📺 │ [S1] 标题 第一季 │ 2019/04 - 2019/09              │
│       │    │ [季度级] AniList 综合 90 热度 98.5k 评分 8.5      │
├──────────────────────────────────────────────────────────────────┤
│       │ 📺 │ [S2] 标题 第二季 │ 2022/10 - 2023/01              │
│       │    │ [季度级] AniList 综合 82 热度 45.2k 评分 8.0      │
└──────────────────────────────────────────────────────────────────┘
```

---

## 开发规范

遵守 `全栈编码规范.md`：
- shadcn/ui 组件优先
- 语义化 Tailwind class
- TypeScript 严格模式
- Server Component 优先
