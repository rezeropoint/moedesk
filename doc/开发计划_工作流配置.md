# MoeDesk 开发计划

## 项目概述

MoeDesk 是一个二次元跨境电商社媒运营工作台，核心功能包括统一管理多平台消息、AI 辅助内容生成、工作流自动化。

---

## 功能模块进度

| 模块 | 路由 | 状态 | 关联 SOP |
|-----|------|------|---------|
| 用户认证 | `/login` | ✅ 已完成 | - |
| 用户管理 | `/admin/users` | ✅ 已完成 | - |
| **工作流配置** | `/workflows` | ✅ 已完成 | 全部 |
| 消息中心 | `/inbox` | ⏳ 待开发 | SOP-08, 09, 10 |
| **热点雷达** | `/trending` | ✅ 已完成 | SOP-01, 02, 03 |
| 内容日历 | `/content` | ⏳ 待开发 | SOP-04, 05, 06, 12 |
| 内容审核 | `/review` | ⏳ 待开发 | SOP-04, 05 |
| 数据报表 | `/analytics` | ⏳ 待开发 | SOP-07, 11, 13 |

---

## 已完成模块

### 1. 用户认证系统
- JWT + Session 认证
- 登录/登出功能
- 路由保护中间件

### 2. 用户管理 (`/admin/users`)
- 用户 CRUD 操作
- 角色管理 (ADMIN/OPERATOR)
- 账号启用/禁用
- 密码重置

### 3. 工作流配置 (`/workflows`) - 2025-12-24 完成

**功能清单**：
- [x] 20 个 SOP 工作流静态配置
- [x] 按阶段分组展示（内容生产/分发/互动/转化）
- [x] 统计概览卡片（活跃/停用/错误/今日执行/成功率）
- [x] 工作流列表表格
- [x] 执行日志弹窗
- [x] 跳转 n8n 编辑器入口
- [x] API Schema 使用 zod 定义并验证

**20 个 SOP 工作流**：

| 阶段 | SOP | 工作流名称 | 触发方式 |
|------|-----|-----------|---------|
| 内容生产 | SOP-01 | AniList 新番同步 | 定时 |
| 内容生产 | SOP-01 | ANN RSS 订阅 | 定时 |
| 内容生产 | SOP-02 | Reddit 热帖抓取 | 定时 |
| 内容生产 | SOP-02 | Twitter 话题监控 | 定时 |
| 内容生产 | SOP-03 | 选题评分计算 | Webhook |
| 内容生产 | SOP-04 | AI 内容生成 | Webhook |
| 内容生产 | SOP-05 | 多平台适配 | Webhook |
| 内容分发 | SOP-06 | 定时发布 | 定时 |
| 内容分发 | SOP-06 | 跨平台同步 | Webhook |
| 内容分发 | SOP-07 | 数据回收 | 定时 |
| 用户互动 | SOP-08 | 消息聚合 | 定时 |
| 用户互动 | SOP-09 | 消息分类 | Webhook |
| 用户互动 | SOP-10 | 自动回复 | Webhook |
| 用户互动 | SOP-10 | 人工回复同步 | Webhook |
| 用户互动 | SOP-11 | 粉丝标签 | 定时 |
| 转化闭环 | SOP-12 | 商品关联 | Webhook |
| 转化闭环 | SOP-12 | 购买链接生成 | Webhook |
| 转化闭环 | SOP-13 | 转化追踪 | 定时 |
| 转化闭环 | SOP-13 | 归因分析 | 定时 |
| 转化闭环 | SOP-13 | 周报生成 | 定时 |

**新增文件**：

| 文件路径 | 类型 | 说明 |
|---------|------|------|
| `types/workflow.ts` | 类型 | 工作流相关类型定义 |
| `lib/n8n.ts` | 服务 | n8n API 封装 + SOP 配置 |
| `app/api/workflows/schema.ts` | Schema | Zod 验证规则 |
| `app/api/workflows/route.ts` | API | 工作流列表接口 |
| `app/api/workflows/[id]/executions/route.ts` | API | 执行日志接口 |
| `components/workflows/workflow-status-badge.tsx` | Server | 状态徽章组件 |
| `components/workflows/workflow-stats.tsx` | Server | 统计卡片组件 |
| `components/workflows/execution-log-dialog.tsx` | Client | 执行日志弹窗 |
| `components/workflows/workflow-table.tsx` | Client | 工作流表格 |
| `components/workflows/workflow-phase-tabs.tsx` | Client | 阶段标签页 |

**API Schema 定义** (符合全栈编码规范)：

```typescript
// app/api/workflows/schema.ts
export const WorkflowListReq = z.object({
  phase: z.enum([...]).optional(),
})

export const ExecutionListReq = z.object({
  limit: z.coerce.number().min(1).max(100).default(20),
  status: z.enum(["success", "error", "running", "waiting"]).optional(),
})
```

Route Handler 使用 `safeParse` 验证请求参数，返回格式统一为 `{ data }` 或 `{ error, details }`。

**修改文件**：
```
app/(dashboard)/workflows/page.tsx   # 页面重写 (Server Component)
.env                                 # 添加 N8N_WEBHOOK_URL, N8N_API_KEY
```

### 4. 热点雷达数据库设计 (`/trending`) - 2025-12-24 完成

**功能设计**：
- [x] 通用 IP 表结构（兼容番剧、游戏、漫画、轻小说、Vtuber 等）
- [x] IP 待审核表（灰色地带数据人工决策）
- [x] 热度追踪表（多源热度 + AI 评估）
- [x] n8n 自动分流逻辑设计

**数据库 Schema**：

| 表名 | 说明 | 关键字段 |
|------|------|---------|
| `ips` | IP 正式库 | type, titleOriginal, totalScore, metadata |
| `ip_reviews` | IP 待审核 | status, reviewedBy, reviewNote |
| `trendings` | 热度追踪 | redditKarma, googleTrend, merchandiseScore, aiAnalysis |

**枚举类型**：

| 枚举 | 值 |
|------|-----|
| `IpType` | ANIME, GAME, MANGA, LIGHT_NOVEL, VTUBER, MOVIE, OTHER |
| `IpSource` | AUTO, MANUAL_APPROVED, MANUAL_ADDED |
| `ReviewStatus` | PENDING, APPROVED, REJECTED |
| `TrendingStatus` | WATCHING, FOCUSED, IN_PROGRESS, ARCHIVED |

**n8n 分流逻辑**：

```
AniList API → n8n 计算综合分 → 三路分流
                                ├─ 高热度 (score≥80) → ips 表（自动入库）
                                ├─ 灰色地带 (60≤score<80) → ip_reviews 表（人工审核）
                                └─ 低热度 (score<60) → 丢弃
```

**metadata JSON 结构示例**：

```json
// ANIME
{ "season": "WINTER", "seasonYear": 2025, "episodes": 12, "studios": ["A-1 Pictures"] }

// GAME
{ "platforms": ["PC", "PS5"], "developer": "miHoYo", "steamId": "123456" }

// VTUBER
{ "agency": "Hololive", "youtubeChannel": "xxx", "subscribers": 1500000 }
```

**修改文件**：

| 文件路径 | 说明 |
|---------|------|
| `prisma/schema.prisma` | 新增 Ip, IpReview, Trending 表及枚举 |
| `init-db.sql` | 同步 DDL，Docker 首次启动时执行 |

### 5. SOP-01 AniList 新番同步工作流 - 2025-12-25 完成

**功能清单**：
- [x] AniList GraphQL API 对接
- [x] 综合评分算法（热度 60% + 评分 40%）
- [x] 三路分流逻辑（高热度/灰色地带/低热度）
- [x] ips 表 + trendings 表自动写入
- [x] ip_reviews 表待审核写入
- [x] Webhook 手动触发版本
- [x] Schedule 定时触发版本

**评分分流规则**：

| 综合分 | 分流 | 目标表 |
|--------|------|--------|
| ≥75 | 高热度 | `ips` + `trendings`（自动入库） |
| 50~74 | 灰色地带 | `ip_reviews`（人工审核） |
| <50 | 低热度 | 丢弃 |

**n8n 工作流结构**：

```
Webhook/Schedule 触发
       │
       ▼
   AniList GraphQL API
       │
       ▼
   Code（数据处理 + SQL 值预处理）
       │
       ▼
   Switch（三路分流）
       │
   ┌───┼───┐
   ▼   ▼   ▼
 ips  reviews  丢弃
(Execute Query)
   │   │   │
   └───┼───┘
       ▼
   Merge (append)
       │
       ▼
   生成响应
```

**新增文件**：

| 文件路径 | 说明 |
|---------|------|
| `n8n-workflows/README.md` | n8n 开发规范和常见问题 |
| `n8n-workflows/sop-01-anilist-sync.json` | 定时触发版本（每周一 09:00） |
| `n8n-workflows/sop-01-anilist-sync-manual.json` | Webhook 手动触发版本 |

**踩坑记录**（详见 `n8n-workflows/README.md`）：

| 问题 | 解决方案 |
|------|----------|
| Postgres Upsert 配置复杂 | 用 `Execute Query` + 原生 SQL |
| NOT NULL 约束报错 | INSERT 显式包含 `createdAt`/`updatedAt` |
| Respond to Webhook 未使用 | 设置 `responseMode` + Merge 合并分支 |
| 跨节点引用 Multiple matches | 多条 SQL 写在一起，用 `$json` 引用 |
| Merge 需要匹配字段 | 改用 `append` 模式 |

**测试命令**：

```bash
# 手动触发同步（默认当前季度）
curl -X POST http://localhost:5678/webhook/sop-01/sync

# 指定季度
curl -X POST http://localhost:5678/webhook/sop-01/sync \
  -H "Content-Type: application/json" \
  -d '{"season": "WINTER", "seasonYear": 2025}'
```

### 6. SOP-02 热度全量刷新工作流 - 2025-12-29 完成

**功能清单**：
- [x] 从数据库查询所有非 REJECTED 的 IP（含 trendingId）
- [x] 按 AniList ID 批量查询最新热度
- [x] 分批处理（每批 50 个，避免 API 限流）
- [x] 更新 ip_reviews 热度字段（popularityScore, ratingScore, totalScore）
- [x] 写入 TrendingHistory 历史记录（仅有 Trending 记录的 IP）
- [x] 计算 7 日变化率并更新 Trending.anilistChange
- [x] 保留原有审核状态不变

**工作流触发**：
- 定时触发：每天 03:00

**更新范围**：
- `status = 'PENDING'` 或 `status = 'APPROVED'` 的 IP
- 不更新 `REJECTED` 状态的 IP

**n8n 工作流结构**：

```
Schedule Trigger (每天 03:00)
       │
       ▼
Postgres (查询待更新 IP + trendingId)
       │
       ▼
Code (分批处理，每批 50 个，建立 ID 映射)
       │
       ▼
Loop Over Items (循环批次)
       │
       ▼
AniList GraphQL (id_in 批量查询)
       │
       ▼
Code (匹配 ID，计算 totalScore)
       │
       ▼
Postgres (UPDATE ip_reviews + INSERT trending_history + UPDATE trendings.anilistChange)
       │
       ▼
等待 1s (避免 API 限流)
       │
       ▼
循环下一批 → 完成后生成统计
```

**新增文件**：

| 文件路径 | 说明 |
|---------|------|
| `n8n-workflows/sop-02-popularity-refresh.json` | 定时触发版本（每天 03:00） |

**与 SOP-01 的分工**：

| 工作流 | 频率 | 范围 | 作用 |
|--------|------|------|------|
| SOP-01 新番同步 | 每周一 09:00 | 当季新番 | 新增 IP 到 ip_reviews |
| SOP-02 热度刷新 | 每天 03:00 | 所有非 REJECTED | 更新热度 + 写入历史 |

### 6.1 SOP-02 Google Trends 追踪工作流 - 2025-12-29 完成

**功能清单**：
- [x] 使用 SerpAPI 获取 Google Trends 搜索热度
- [x] 写入 TrendingHistory 表（source: GOOGLE_TRENDS）
- [x] 更新 Trending 表的 googleTrend 字段
- [x] 支持全球数据采集（Worldwide）

**工作流触发**：
- 定时触发：每天 04:00

**API 配置**：
- SerpAPI Key：在 n8n Settings → Variables 中配置 `SERPAPI_KEY`
- 免费版每月 100 次请求

**新增文件**：

| 文件路径 | 说明 |
|---------|------|
| `n8n-workflows/sop-02-google-trends.json` | 定时触发版本（每天 04:00） |

### 6.2 SOP-02 Reddit Karma 监测工作流 - 2025-12-29 完成

**功能清单**：
- [x] 使用 Reddit 公开 API 搜索 r/anime 讨论
- [x] 统计帖子 karma 总和
- [x] 写入 TrendingHistory 表（source: REDDIT）
- [x] 更新 Trending 表的 redditKarma 字段

**工作流触发**：
- 定时触发：每天 05:00

**API 配置**：
- 无需认证，使用公开 API（限制 100 QPM）
- User-Agent 已配置为 `MoeDesk/1.0`

**新增文件**：

| 文件路径 | 说明 |
|---------|------|
| `n8n-workflows/sop-02-reddit-monitor.json` | 定时触发版本（每天 05:00） |

### 6.3 TrendingHistory 表新增 region 字段 - 2025-12-29 完成

**数据库变更**：
- 新增 `region` 字段，类型 `TEXT`，默认值 `'GLOBAL'`
- 用于区分不同地区的热度数据（如 US/JP/GB 等）

**修改文件**：

| 文件路径 | 说明 |
|---------|------|
| `prisma/schema.prisma` | 新增 region 字段 |
| `init-db.sql` | 同步 DDL |

### 7. 热点雷达前端 (`/trending`) - 2025-12-25 完成

**功能清单**：
- [x] 统计概览卡片（IP 总数/追踪中/待审核/观望中/重点关注/已创建选题）
- [x] 热点列表展示（排名、热度指示）
- [x] IP 审核功能（通过/拒绝待审核 IP，集成在页面 Tab，含详情弹窗）
- [x] 侧边面板（本周新番 + 占位面板）
- [x] API Schema 使用 zod 定义并验证

### 8. 热点列表详情优化 - 2025-12-26 完成

**功能清单**：
- [x] 扩展 API 返回完整 IP 信息和社媒热度数据
- [x] 新增 HeatData 类型定义
- [x] 实现热点详情弹窗（封面、评分、标签、简介、热度数据）
- [x] 采用双行紧凑布局：标题行 + 评分/热度行
- [x] 社媒热度始终显示（空值显示 "-"）
- [x] 刷新按钮移至 Tab 栏同行
- [x] 移除来源筛选功能

**修改文件**：

| 文件路径 | 说明 |
|---------|------|
| `app/(dashboard)/trending/page.tsx` | 添加刷新时间状态 |
| `app/api/trendings/route.ts` | 扩展返回 IP 和热度数据 |
| `components/trending/trending-item.tsx` | 重构为详情弹窗形式 |
| `components/trending/trending-list.tsx` | 简化为数据容器 |
| `components/trending/trending-tabs.tsx` | 刷新按钮移入 + 精简筛选 |
| `types/trending.ts` | 新增 HeatData 类型 |

**页面布局**：

```
┌─────────────────────────────────────────────────────────────┐
│ 🔥 热点雷达          [最后更新: 5分钟前] [立即刷新]         │
├─────────────────────────────────────────────────────────────┤
│ [统计卡片 x 6]                                              │
├────────────────────────────────────┬────────────────────────┤
│ [实时热点] [待审核 🔴]              │ 📅 本周新番            │
│ [全部] [Reddit] [Twitter]...       │ 🎯 热点产品匹配(占位)  │
│ 热点列表...                        │ ⚙️ 监测设置(占位)      │
└────────────────────────────────────┴────────────────────────┘
```

**新增文件**：

| 文件路径 | 类型 | 说明 |
|---------|------|------|
| `types/trending.ts` | 类型 | 热点模块类型定义 |
| `lib/trending.ts` | 服务 | 热点统计数据获取函数 |
| `app/api/ips/schema.ts` | Schema | IP 列表 Zod 验证 |
| `app/api/ips/route.ts` | API | GET 已入库 IP 列表 |
| `app/api/trendings/schema.ts` | Schema | 热度数据 Zod 验证 |
| `app/api/trendings/route.ts` | API | GET 热度数据列表 |
| `app/api/ip-reviews/schema.ts` | Schema | 审核 Zod 验证 |
| `app/api/ip-reviews/route.ts` | API | GET 待审核列表 |
| `app/api/ip-reviews/[id]/approve/route.ts` | API | POST 审核通过 |
| `app/api/ip-reviews/[id]/reject/route.ts` | API | POST 审核拒绝 |
| `components/trending/ip-type-badge.tsx` | Server | IP 类型徽章 |
| `components/trending/trending-stats.tsx` | Server | 统计卡片组件 |
| `components/trending/trending-item.tsx` | Client | 热点列表项 |
| `components/trending/trending-list.tsx` | Client | 热点列表 |
| `components/trending/ip-review-item.tsx` | Client | 待审核项 |
| `components/trending/ip-review-list.tsx` | Client | 待审核列表 |
| `components/trending/trending-tabs.tsx` | Client | Tab 切换 |
| `components/trending/anime-schedule.tsx` | Server | 本周新番面板 |
| `components/trending/product-match-panel.tsx` | Server | 产品匹配占位 |
| `components/trending/monitor-settings-panel.tsx` | Server | 监测设置占位 |
| `components/trending/trending-side-panel.tsx` | Server | 侧边面板容器 |

**API 接口**：

| 路径 | 方法 | 说明 |
|------|------|------|
| `/api/ips` | GET | IP 列表（支持筛选、分页、排序） |
| `/api/trendings` | GET | 热度数据列表 |
| `/api/ip-reviews` | GET | 待审核列表 |
| `/api/ip-reviews/[id]/approve` | POST | 审核通过（事务：更新状态+创建 IP+创建 Trending） |
| `/api/ip-reviews/[id]/reject` | POST | 审核拒绝（需填写拒绝原因） |

**修改文件**：

| 文件路径 | 说明 |
|---------|------|
| `app/(dashboard)/trending/page.tsx` | 页面重写（Server Component） |
| `package.json` | 新增 date-fns 依赖 |

### 9. TimescaleDB 热度历史表 - 2025-12-29 完成

**功能清单**：
- [x] 迁移到 TimescaleDB（替换 PostgreSQL）
- [x] 新增 TrendingHistory 时序表
- [x] 配置 hypertable 自动分区（7天一个 chunk）
- [x] 配置压缩策略（7天后压缩）
- [x] 配置数据保留策略（保留1年）
- [x] Trending 表新增热度变化率字段

**数据库 Schema 变更**：

| 表名 | 变更 | 说明 |
|------|------|------|
| `trending_history` | 新增 | 热度历史时序表（TimescaleDB hypertable） |
| `trendings` | 新增字段 | anilistChange, googleTrendChange, redditKarmaChange 等变化率字段 |

**TrendingHistory 字段**：

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | String | 主键（复合主键之一） |
| `trendingId` | String | 关联 Trending |
| `source` | TrendingSource | 数据来源 |
| `popularity` | Int | 热度值（如 AniList popularity） |
| `rating` | Int? | 评分（如 AniList averageScore） |
| `metadata` | Json? | 额外数据（预留扩展） |
| `recordedAt` | DateTime | 记录时间（复合主键之一） |

**TrendingSource 枚举**：

| 值 | 说明 |
|----|------|
| GOOGLE_TRENDS | Google 搜索趋势 |
| REDDIT | Reddit karma |
| TWITTER | Twitter/X 提及 |
| BILIBILI | B站弹幕/播放 |
| ANILIST | AniList 热度/评分 |

**TimescaleDB 特性**：

- **自动分区**：按 `recordedAt` 每 7 天一个 chunk
- **自动压缩**：7 天前的数据自动压缩，节省存储
- **自动清理**：1 年前的数据自动删除

**修改文件**：

| 文件路径 | 说明 |
|---------|------|
| `docker-compose.yml` | 镜像改为 timescale/timescaledb:latest-pg16 |
| `prisma/schema.prisma` | 新增 TrendingHistory 模型和 TrendingSource 枚举 |
| `init-db.sql` | 启用 TimescaleDB 扩展，创建 hypertable |

### 10. 完结日期显示功能 - 2025-12-29 完成

**功能清单**：
- [x] 热点列表显示开播日期和完结日期
- [x] 待审核列表显示开播日期和完结日期
- [x] 详情弹窗显示完整日期信息

**修改文件**：

| 文件路径 | 说明 |
|---------|------|
| `app/(dashboard)/trending/page.tsx` | 查询和映射添加 endDate 字段 |
| `components/trending/trending-tabs.tsx` | IpReviewListItem 接口添加 endDate |
| `components/trending/trending-item.tsx` | UI 显示开播/完结日期 |
| `components/trending/ip-review-item.tsx` | UI 显示开播/完结日期 |
| `types/trending.ts` | TrendingListItem 添加 endDate 字段 |

### 11. 审核流程优化 - 2025-12-29 完成

**问题修复**：
- 修复"实时热点"显示未审核 IP 的问题
- 简化 n8n 工作流，移除预创建 Trending 逻辑

**审核流程设计**：

```
n8n 同步 → ip_reviews (PENDING)
              │
              ▼
         人工审核
              │
    ┌─────────┴─────────┐
    ▼                   ▼
  通过                 拒绝
    │                   │
    ▼                   ▼
APPROVED + 创建 Trending   REJECTED
    │
    ▼
实时热点显示
```

**关键逻辑**：
- Trending 记录仅在审核通过时创建（`/api/ip-reviews/[id]/approve`）
- 实时热点查询过滤 `ip.status = 'APPROVED'`
- n8n 同步工作流只写入 `ip_reviews` 表

**修改文件**：

| 文件路径 | 说明 |
|---------|------|
| `app/(dashboard)/trending/page.tsx` | Trending 查询添加 `ip.status = 'APPROVED'` 过滤 |
| `app/api/trendings/route.ts` | API 查询添加 `ip.status = 'APPROVED'` 过滤 |
| `n8n-workflows/sop-01-anilist-sync.json` | 移除预创建 Trending/TrendingHistory 逻辑 |

### 12. 日期显示优化 - 2025-12-29 完成

**优化内容**：
- 列表日期格式简化为 `2025/10/4 - 2025/12/27`
- 使用 shadcn Tooltip 组件显示悬浮提示（"开播 - 完结"）
- 详情弹窗保留完整格式

**修改文件**：

| 文件路径 | 说明 |
|---------|------|
| `components/trending/trending-item.tsx` | 添加 Tooltip 组件，简化日期格式 |
| `components/trending/ip-review-item.tsx` | 添加 Tooltip 组件，简化日期格式 |

### 13. 热度飙升计算功能 - 2025-12-29 完成

**功能清单**：
- [x] 热度飙升 API：从 TrendingHistory 实时计算 7 日变化率
- [x] 配置 API：支持全局配置读写（阈值、权重）
- [x] HeatSurgePanel 组件：展示 Top N 飙升 IP
- [x] 支持飙升阈值自定义（10%-200%）
- [x] 支持多源权重自定义（AniList/Google/Reddit/Twitter/Bilibili）
- [x] 删除冗余的 heatLevel 功能

**设计决策**：

| 问题 | 决策 |
|------|------|
| 变化率存储 vs 实时计算 | 实时计算（因刷新时间不固定，存储不准确） |
| 阈值存储位置 | 数据库 SystemConfig 表（全局配置） |
| 数据源 | 多源加权综合（可自定义权重） |

**加权公式**：

```typescript
// 默认权重
const SOURCE_WEIGHTS = {
  anilist: 0.30,   // AniList 核心数据
  google: 0.25,    // Google Trends 搜索热度
  reddit: 0.20,    // Reddit karma
  twitter: 0.15,   // Twitter 提及
  bilibili: 0.10,  // B站热度
}

// 综合变化率 = 有效数据源的加权平均
compositeChange = weightedSum / availableWeightSum
```

**数据库变更**：

| 变更 | 说明 |
|------|------|
| 删除 `trendings.xxxChange` 字段 | 5 个变化率字段改为实时计算 |
| 新增 `system_configs` 表 | 存储全局配置（key-value） |
| 删除 n8n 变化率计算 | `sop-02-popularity-refresh.json` 移除相关 SQL |

**新增文件**：

| 文件路径 | 类型 | 说明 |
|---------|------|------|
| `app/api/configs/[key]/route.ts` | API | 配置读写（GET/PUT） |
| `app/api/configs/[key]/schema.ts` | Schema | 配置 Zod 验证 |
| `app/api/trendings/surge/route.ts` | API | 热度飙升数据（实时计算） |
| `app/api/trendings/surge/schema.ts` | Schema | 飙升查询 Zod 验证 |
| `components/ui/slider.tsx` | UI | shadcn Slider 组件 |
| `components/ui/popover.tsx` | UI | shadcn Popover 组件 |

**修改文件**：

| 文件路径 | 说明 |
|---------|------|
| `prisma/schema.prisma` | 删除变化率字段，新增 SystemConfig |
| `init-db.sql` | 同步 DDL，插入默认配置 |
| `n8n-workflows/sop-02-popularity-refresh.json` | 移除变化率计算 SQL |
| `components/trending/heat-surge-panel.tsx` | 重写为完整功能组件 |
| `components/trending/trending-item.tsx` | 删除 heatLevel 火焰图标 |
| `types/trending.ts` | 新增 SurgeItem、SurgeConfig 等类型 |

**飙升 API SQL 核心逻辑**：

```sql
WITH latest AS (
  -- 每个 IP 每个数据源的最新记录
  SELECT DISTINCT ON ("trendingId", source) ...
),
old AS (
  -- 7天前最近的记录
  SELECT DISTINCT ON ("trendingId", source) ...
  WHERE "recordedAt" < NOW() - INTERVAL '7 days'
),
changes AS (
  -- 计算各数据源变化率
  SELECT ... ROUND(((l.popularity - o.popularity) / o.popularity * 100), 2) AS change_rate
),
weighted AS (
  -- 加权综合变化率
  SELECT ... (weighted_sum / available_weight_sum) AS composite_change
)
SELECT ... WHERE composite_change >= threshold ORDER BY composite_change DESC
```

---

## 待开发模块

### 消息中心 (`/inbox`)
统一聚合多平台消息，AI 自动分类，快捷回复。

### 热点雷达 (`/trending`) ✅ 已完成
新番日历、Reddit 热度排行、选题决策。

**已完成**：
- [x] IP 审核页面（通过/拒绝待审核 IP）✅ 2025-12-25
- [x] 热点列表页面（展示已入库 IP + 热度数据）✅ 2025-12-25
- [x] n8n 工作流搭建（AniList 同步 + 分流逻辑）✅ 2025-12-25
- [x] API: GET/POST `/api/ip-reviews` ✅ 2025-12-25
- [x] API: GET `/api/ips`, `/api/trendings` ✅ 2025-12-25
- [x] 热点详情弹窗（封面、评分、标签、简介、热度数据）✅ 2025-12-26

**待迭代**：
- [ ] 热点产品匹配功能
- [ ] 监测设置功能

### 内容日历 (`/content`)
日/周/月视图排期、内容创建、平台预览。

### 内容审核 (`/review`)
待审核队列、平台适配检查、批量操作。

### 数据报表 (`/analytics`)
内容表现、渠道分析、KOC 管理、归因报表。

---

## 技术栈

- **前端**：Next.js 16 + React 19 + TypeScript + Tailwind CSS v4 + shadcn/ui
- **数据库**：TimescaleDB (PostgreSQL 扩展) + Prisma ORM
- **工作流**：n8n (Docker 部署)
- **认证**：JWT + Session

---

## 环境配置

```env
DATABASE_URL="postgresql://postgres:postgres@localhost:15432/moedesk"
JWT_SECRET="your-secret-key"
N8N_WEBHOOK_URL="http://localhost:5678"
N8N_API_KEY=""
```

---

## 开发规范

遵守 `全栈编码规范.md`，主要包括：
- 禁止原生 HTML 交互元素，使用 shadcn/ui
- 禁止硬编码颜色，使用语义化 Tailwind class
- 禁止 any 类型
- 优先 Server Component
- Route Handler params 使用 `await context.params`
