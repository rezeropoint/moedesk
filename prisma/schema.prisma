// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  OPERATOR
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String
  name         String
  role         Role      @default(OPERATOR)
  avatar       String?
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  lastLoginAt  DateTime?
  sessions     Session[]
  socialAccounts SocialAccount[]

  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@map("sessions")
}

// ============================================================================
// IP 相关表（泛宅文化：番剧、游戏、漫画、轻小说、Vtuber 等）
// ============================================================================

/// IP 类型枚举
enum IpType {
  ANIME        // 番剧
  GAME         // 游戏
  MANGA        // 漫画
  LIGHT_NOVEL  // 轻小说
  VTUBER       // 虚拟主播
  MOVIE        // 剧场版/电影
  OTHER        // 其他
}

/// 审核状态枚举
enum ReviewStatus {
  PENDING   // 待审核
  APPROVED  // 已通过
  REJECTED  // 已拒绝
}

/// 热度追踪状态枚举
enum TrendingStatus {
  WATCHING     // 观望中
  FOCUSED      // 重点关注
  IN_PROGRESS  // 已创建选题
  ARCHIVED     // 已归档
}

/// 热度来源枚举
enum TrendingSource {
  GOOGLE_TRENDS // Google 搜索趋势
  REDDIT        // Reddit karma
  TWITTER       // Twitter/X 提及
  BILIBILI      // B站弹幕/播放
  ANILIST       // AniList 评分
}

/// 系列表（如：鬼灭之刃整个系列）
model Series {
  id              String    @id @default(cuid())

  // 系列名称（多语言）
  titleOriginal   String                           // 原始标题 (日文/英文)
  titleChinese    String?                          // 中文标题
  titleEnglish    String?                          // 英文标题

  // 系列信息
  type            IpType                           // 主类型 (ANIME/GAME/...)
  coverImage      String?                          // 系列封面
  description     String?                          // 系列简介
  tags            String[]  @default([])           // 标签

  // 搜索关键词（用于社媒数据匹配）
  searchKeywords  String[]  @default([])           // ["Demon Slayer", "鬼灭之刃"]

  // 统计字段（审核时自动计算）
  totalSeasons    Int       @default(0)            // 季数
  aggregatedScore Int       @default(0)            // 聚合评分

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // 关联
  entries         Entry[]                          // 包含的所有季度
  trending        Trending?                        // 系列级热度追踪
  publishTasks    PublishTask[]                    // 发布任务

  @@index([type])
  @@index([aggregatedScore])
  @@map("series")
}

/// IP 条目表 - 单个 IP 数据（如某一季动画）
model Entry {
  id            String    @id                      // 外部平台 ID
  type          IpType

  // 基础信息
  titleOriginal String
  titleChinese  String?
  titleEnglish  String?
  description   String?
  coverImage    String?
  tags          String[]

  releaseDate   DateTime?
  endDate       DateTime?

  popularityScore  Int?
  ratingScore      Int?
  totalScore       Int      @default(0)

  metadata      Json?
  externalUrls  Json?

  // 系列关联
  seriesId      String?                            // 所属系列（可空，支持独立 IP）
  series        Series? @relation(fields: [seriesId], references: [id])
  seasonNumber  Int?                               // 第几季 (1, 2, 3...)
  seasonLabel   String?                            // 季度标签 ("S1", "剧场版", "OVA")

  // 审核相关
  status        ReviewStatus @default(PENDING)
  reviewedBy    String?                            // 审核人 User.id
  reviewedAt    DateTime?
  reviewNote    String?                            // 审核备注（拒绝原因等）

  createdAt     DateTime  @default(now())

  @@index([status])
  @@index([type])
  @@index([totalScore])
  @@index([seriesId])
  @@map("entries")
}

/// 热度追踪表 - 运营决策数据（关联到系列级）
model Trending {
  id              String   @id @default(cuid())

  // 关联系列
  seriesId        String   @unique                 // 所属系列
  series          Series @relation(fields: [seriesId], references: [id], onDelete: Cascade)

  // 多源热度数据（定时更新）
  redditKarma     Int?                             // Reddit karma（番剧）
  googleTrend     Int?                             // Google Trends 分数
  twitterMentions Int?                             // Twitter/X 提及数
  biliDanmaku     Int?                             // B站弹幕数（可选）

  // AI 评估结果
  merchandiseScore Int?                            // 周边潜力分 (0-100)
  aiAnalysis       Json?                           // AI 分析详情
  // { pros: [], cons: [], timing: "", productSuggestions: [] }

  // 运营状态
  status          TrendingStatus @default(WATCHING)

  // 时间戳
  evaluatedAt     DateTime?                        // AI 评估时间
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // 关联历史
  history         TrendingHistory[]

  @@index([status])
  @@index([merchandiseScore])
  @@map("trendings")
}

/// 热度历史表 - 时序数据（TimescaleDB hypertable）
model TrendingHistory {
  id          String         @default(cuid())
  trendingId  String
  trending    Trending       @relation(fields: [trendingId], references: [id], onDelete: Cascade)

  source      TrendingSource                      // 数据来源
  region      String         @default("GLOBAL")  // 地区代码（GLOBAL/US/JP/GB/DE/FR 等）
  popularity  Int                                 // 热度值（如 AniList popularity）
  rating      Int?                                // 评分（如 AniList averageScore）
  metadata    Json?                               // 额外数据（搜索关键词等）

  recordedAt  DateTime       @default(now())

  // 复合主键：TimescaleDB hypertable 要求分区列在主键中
  @@id([id, recordedAt])
  @@index([trendingId, source])
  @@index([source, recordedAt(sort: Desc)])
  @@index([trendingId, source, recordedAt(sort: Desc)])
  @@map("trending_history")
}

/// 系统配置表 - 存储全局配置
model SystemConfig {
  key       String   @id              // 配置键名
  value     String                    // 配置值（JSON 格式）
  updatedAt DateTime @updatedAt

  @@map("system_configs")
}

// ============================================================================
// 发布相关表（多平台内容发布）
// ============================================================================

/// 社媒账号状态枚举
enum SocialAccountStatus {
  PENDING   // 待验证
  ACTIVE    // 正常
  EXPIRED   // 授权过期
  DISABLED  // 已禁用
}

/// 发布状态枚举
enum PublishStatus {
  DRAFT           // 草稿
  SCHEDULED       // 已排期
  PUBLISHING      // 发布中
  PUBLISHED       // 已发布
  PARTIAL_FAILED  // 部分失败
  FAILED          // 全部失败
}

/// 发布平台枚举
enum PublishPlatform {
  INSTAGRAM
  THREADS
  YOUTUBE
  // 后续扩展：TIKTOK, TWITTER
}

/// 发布模式枚举
enum PublishMode {
  IMMEDIATE   // 立即发布
  SCHEDULED   // 定时发布
  MANUAL      // 人工发布
}

/// 社媒账号表 - 存储用户绑定的各平台账号
model SocialAccount {
  id            String              @id @default(cuid())

  // 所有者
  userId        String
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 平台信息
  platform      PublishPlatform                           // 平台类型
  accountName   String                                    // 账号名称/昵称，如 @moedesk_official
  accountId     String?                                   // 平台账号 ID（OAuth 获取）
  accountUrl    String?                                   // 账号主页链接
  avatarUrl     String?                                   // 账号头像

  // 授权信息（预留 OAuth）
  accessToken   String?                                   // 访问令牌（加密存储）
  refreshToken  String?                                   // 刷新令牌（加密存储）
  tokenExpiry   DateTime?                                 // 令牌过期时间

  // YouTube 频道统计数据（JSON）
  channelStats  Json?                                     // { subscriberCount, videoCount, viewCount, fetchedAt }

  // Google 账户信息（YouTube 专用）
  googleAccountId   String?                               // Google 账户 ID (sub)
  googleEmail       String?                               // Google 邮箱
  googleName        String?                               // Google 账户名称

  // 状态
  status        SocialAccountStatus @default(ACTIVE)

  // 时间戳
  lastUsedAt    DateTime?                                 // 最后使用时间
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  // 关联
  taskAccounts   PublishTaskAccount[]
  publishRecords PublishRecord[]

  @@unique([userId, platform, accountName])
  @@index([userId, platform])
  @@index([status])
  @@map("social_accounts")
}

/// 发布任务-账号关联表（多对多）
model PublishTaskAccount {
  id          String        @id @default(cuid())
  taskId      String
  task        PublishTask   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  accountId   String
  account     SocialAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  createdAt   DateTime      @default(now())

  @@unique([taskId, accountId])
  @@index([taskId])
  @@index([accountId])
  @@map("publish_task_accounts")
}

/// 发布任务表
model PublishTask {
  id            String            @id @default(cuid())

  // 内容信息
  title         String                                // 内容标题
  videoUrl      String?                               // 视频文件 URL
  coverUrl      String?                               // 封面 URL
  seriesId      String?                               // 关联系列（可选）
  series        Series?           @relation(fields: [seriesId], references: [id])

  // 发布配置
  platforms     PublishPlatform[]                     // 目标平台列表
  mode          PublishMode       @default(SCHEDULED)
  scheduledAt   DateTime?                             // 排期时间

  // 状态
  status        PublishStatus     @default(DRAFT)

  // 时间戳
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  createdBy     String                                // User.id

  // 关联
  platformContents PublishPlatformContent[]
  records          PublishRecord[]
  taskAccounts     PublishTaskAccount[]

  @@index([status])
  @@index([scheduledAt])
  @@index([createdBy])
  @@map("publish_tasks")
}

/// 平台文案表 - 各平台的定制内容
model PublishPlatformContent {
  id          String          @id @default(cuid())
  taskId      String
  task        PublishTask     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  platform    PublishPlatform
  title       String?                               // 平台特定标题
  description String?                               // 平台特定描述
  hashtags    String[]                              // Hashtag 列表

  @@unique([taskId, platform])
  @@map("publish_platform_contents")
}

/// 发布记录表 - 单次发布的执行记录
model PublishRecord {
  id          String          @id @default(cuid())
  taskId      String
  task        PublishTask     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  platform    PublishPlatform
  accountId   String?                               // 使用的社媒账号 ID
  account     SocialAccount?  @relation(fields: [accountId], references: [id])
  status      PublishStatus
  externalId  String?                               // 平台返回的内容 ID
  externalUrl String?                               // 平台上的内容链接

  errorMessage String?
  publishedAt  DateTime?

  createdAt   DateTime        @default(now())

  @@index([taskId])
  @@index([platform])
  @@index([accountId])
  @@map("publish_records")
}
