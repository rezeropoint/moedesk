// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  OPERATOR
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String
  name         String
  role         Role      @default(OPERATOR)
  avatar       String?
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  lastLoginAt  DateTime?
  sessions     Session[]

  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@map("sessions")
}

// ============================================================================
// IP 相关表（泛宅文化：番剧、游戏、漫画、轻小说、Vtuber 等）
// ============================================================================

/// IP 类型枚举
enum IpType {
  ANIME        // 番剧
  GAME         // 游戏
  MANGA        // 漫画
  LIGHT_NOVEL  // 轻小说
  VTUBER       // 虚拟主播
  MOVIE        // 剧场版/电影
  OTHER        // 其他
}

/// 审核状态枚举
enum ReviewStatus {
  PENDING   // 待审核
  APPROVED  // 已通过
  REJECTED  // 已拒绝
}

/// 热度追踪状态枚举
enum TrendingStatus {
  WATCHING     // 观望中
  FOCUSED      // 重点关注
  IN_PROGRESS  // 已创建选题
  ARCHIVED     // 已归档
}

/// 热度来源枚举
enum TrendingSource {
  GOOGLE_TRENDS // Google 搜索趋势
  REDDIT        // Reddit karma
  TWITTER       // Twitter/X 提及
  BILIBILI      // B站弹幕/播放
  ANILIST       // AniList 评分
}

/// IP 表 - 所有 IP 数据（通过 status 控制审核状态）
model IpReview {
  id            String    @id                      // 外部平台 ID
  type          IpType

  // 基础信息（同 Ip 表）
  titleOriginal String
  titleChinese  String?
  titleEnglish  String?
  description   String?
  coverImage    String?
  tags          String[]

  releaseDate   DateTime?
  endDate       DateTime?

  popularityScore  Int?
  ratingScore      Int?
  totalScore       Int      @default(0)

  metadata      Json?
  externalUrls  Json?

  // 审核相关
  status        ReviewStatus @default(PENDING)
  reviewedBy    String?                            // 审核人 User.id
  reviewedAt    DateTime?
  reviewNote    String?                            // 审核备注（拒绝原因等）

  createdAt     DateTime  @default(now())

  // 关联
  trendings     Trending[]

  @@index([status])
  @@index([type])
  @@index([totalScore])
  @@map("ip_reviews")
}

/// 热度追踪表 - 运营决策数据
model Trending {
  id              String   @id @default(cuid())

  // 关联 IP
  ipId            String
  ip              IpReview @relation(fields: [ipId], references: [id], onDelete: Cascade)

  // 多源热度数据（定时更新）
  redditKarma     Int?                             // Reddit karma（番剧）
  googleTrend     Int?                             // Google Trends 分数
  twitterMentions Int?                             // Twitter/X 提及数
  biliDanmaku     Int?                             // B站弹幕数（可选）

  // AI 评估结果
  merchandiseScore Int?                            // 周边潜力分 (0-100)
  aiAnalysis       Json?                           // AI 分析详情
  // { pros: [], cons: [], timing: "", productSuggestions: [] }

  // 运营状态
  status          TrendingStatus @default(WATCHING)

  // 时间戳
  evaluatedAt     DateTime?                        // AI 评估时间
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // 关联历史
  history         TrendingHistory[]

  @@unique([ipId])                                 // 一个 IP 只有一条 Trending 记录
  @@index([status])
  @@index([merchandiseScore])
  @@map("trendings")
}

/// 热度历史表 - 时序数据（TimescaleDB hypertable）
model TrendingHistory {
  id          String         @default(cuid())
  trendingId  String
  trending    Trending       @relation(fields: [trendingId], references: [id], onDelete: Cascade)

  source      TrendingSource                      // 数据来源
  region      String         @default("GLOBAL")  // 地区代码（GLOBAL/US/JP/GB/DE/FR 等）
  popularity  Int                                 // 热度值（如 AniList popularity）
  rating      Int?                                // 评分（如 AniList averageScore）
  metadata    Json?                               // 额外数据（搜索关键词等）

  recordedAt  DateTime       @default(now())

  // 复合主键：TimescaleDB hypertable 要求分区列在主键中
  @@id([id, recordedAt])
  @@index([trendingId, source])
  @@index([source, recordedAt(sort: Desc)])
  @@index([trendingId, source, recordedAt(sort: Desc)])
  @@map("trending_history")
}

/// 系统配置表 - 存储全局配置
model SystemConfig {
  key       String   @id              // 配置键名
  value     String                    // 配置值（JSON 格式）
  updatedAt DateTime @updatedAt

  @@map("system_configs")
}
