# 全栈编码规范

> Next.js 16 + React 19 + Tailwind CSS v4 + shadcn/ui (new-york)

---

## 核心原则

1. **禁止废弃 API** - 使用框架最新推荐写法
2. **shadcn/ui 优先** - 禁止原生 HTML 交互元素（button/input/select 等）
3. **Tailwind CSS 优先** - 使用语义化 class，禁止硬编码颜色和内联 style
4. **TypeScript 严格** - 禁止 any，所有参数必须定义类型
5. **RSC 优先** - 优先 Server Components，必要时才用 `"use client"`
6. **前后端分离** - 前端负责展示交互，后端（API Route / n8n）处理业务逻辑

---

## React 19 新特性（必须使用）

```tsx
// ref 作为 prop（不再需要 forwardRef）
function Input({ ref, ...props }: { ref?: React.Ref<HTMLInputElement> }) {
  return <input ref={ref} {...props} />
}

// use() hook 替代 useEffect 数据获取
const comments = use(commentsPromise)

// useActionState 替代手动管理表单状态
const [state, action, isPending] = useActionState(submitForm, initialState)

// useOptimistic 乐观更新
const [optimisticMessages, addOptimistic] = useOptimistic(messages, reducer)
```

### React 废弃 API（禁止使用）

| 废弃 API | 替代方案 |
|----------|----------|
| `forwardRef` | 直接传 ref prop |
| `useEffect` 数据获取 | `use()` + Suspense |
| `PropTypes` | TypeScript |
| `defaultProps` | ES6 默认参数 |

---

## Next.js 16 新特性（必须使用）

```tsx
// App Router Server Component
export default async function MessagesPage() {
  const data = await fetchMessages()
  return <MessageList messages={data} />
}

// Route Handlers（params 是 Promise）
type RouteContext = { params: Promise<{ id: string }> }
export async function GET(request: NextRequest, context: RouteContext) {
  const { id } = await context.params
  return Response.json({ data: message })
}

// Server Actions
"use server"
export async function createMessage(formData: FormData) {
  await db.message.create({ data: { content } })
  revalidatePath("/messages")
}
```

### Next.js 废弃写法（禁止使用）

| 废弃写法 | 替代方案 |
|----------|----------|
| `pages/` 目录 | `app/` 目录 |
| `getServerSideProps` | Server Component 直接 fetch |
| `getStaticProps` | Server Component + cache |
| `/pages/api/*.ts` | `/app/api/*/route.ts` |
| `next/head` | `metadata` 导出 |

---

## 组件使用规范

### 禁止原生 HTML 交互元素

| 原生 HTML | 使用替代 |
|-----------|----------|
| `<button>` | `<Button>` |
| `<input>` | `<Input>` / `<Textarea>` |
| `<select>` | `<Select>` |
| `<checkbox>` | `<Checkbox>` |
| `<dialog>` | `<Dialog>` / `<Sheet>` |
| `<table>` | `<Table>` |

### 允许使用原生 HTML

- 语义化结构：`<header>` / `<main>` / `<section>` / `<article>` / `<nav>`
- 布局容器：`<div>` 用于 flex/grid
- 文本元素：`<p>` / `<span>` / `<h1>`~`<h6>`
- 列表展示：`<ul>` / `<ol>` / `<li>`
- 图片和链接：`<img>` / `<a>` 配合 Next.js `<Link>`

---

## 样式规范

```tsx
// ✅ 语义化 Tailwind class + cn() 条件样式
<div className={cn("p-4 bg-card text-muted-foreground", isActive && "bg-primary")}>

// ❌ 禁止硬编码颜色
<div className="bg-[#ffffff] text-[#333]">

// ❌ 禁止内联 style（动态计算值除外）
<div style={{ padding: '16px' }}>

// ✅ 允许：动态计算值
<div style={{ left: `${position}px`, width: `${progress}%` }} />
```

### 语义化颜色

| 用途 | Tailwind Class |
|------|---------------|
| 页面背景 | `bg-background` |
| 卡片背景 | `bg-card` |
| 次要背景 | `bg-muted` |
| 主文本 | `text-foreground` |
| 次要文本 | `text-muted-foreground` |
| 主题色 | `bg-primary` / `text-primary` |
| 危险色 | `bg-destructive` / `text-destructive` |
| 边框 | `border-border` |

### 品牌色（第三方平台）

品牌色必须在 `globals.css` 中定义 CSS 变量，禁止使用 Tailwind 调色板（如 `text-pink-500`）或 inline style。

```css
/* globals.css - 已定义的品牌色 */
--brand-anilist    /* AniList 蓝 */
--brand-bilibili   /* B站 粉 */
--brand-instagram  /* Instagram 粉红 */
--brand-youtube    /* YouTube 红 */
--brand-threads    /* Threads 黑 */
```

```tsx
// ✅ 正确：使用 CSS 变量
<Icon className="text-brand-instagram" />

// ❌ 错误：Tailwind 调色板
<Icon className="text-pink-500" />

// ❌ 错误：inline style
<Icon style={{ color: "#E4405F" }} />
```

**添加新品牌色步骤：**
1. 在 `globals.css` 的 `:root` 中定义 `--brand-xxx`
2. 在 `@theme inline` 块中添加 `--color-brand-xxx: var(--brand-xxx)`
3. 组件中使用 `text-brand-xxx` / `bg-brand-xxx`

### 响应式断点

| 断点 | 宽度 | 设备 |
|------|------|------|
| 默认 | < 768px | 手机 |
| `md:` | >= 768px | 平板 |
| `lg:` | >= 1024px | 笔记本 |
| `xl:` | >= 1280px | 桌面 |

---

## 图标规范

统一使用 **Lucide React**，禁止混用其他图标库。

| 场景 | 尺寸 |
|------|------|
| 按钮内/图标按钮 | `h-4 w-4` |
| 列表项 | `h-5 w-5` |
| 卡片 | `h-6 w-6` |
| 空状态 | `h-12 w-12` |

---

## 页面布局规范

Dashboard 页面统一使用 `p-8` 内边距（layout 只提供 `pl-60` 避开侧边栏）。

```tsx
// ✅ 正确：页面自带内边距
export default function SomePage() {
  return (
    <div className="p-8 space-y-6">
      {/* 页面标题带图标 */}
      <div className="flex items-center gap-3">
        <div className="p-2 bg-primary/10 rounded-lg">
          <SomeIcon className="h-6 w-6 text-primary" />
        </div>
        <div>
          <h1 className="text-2xl font-bold">页面标题</h1>
          <p className="text-muted-foreground">页面描述</p>
        </div>
      </div>
      {/* 内容区 */}
    </div>
  )
}

// ❌ 错误：缺少内边距
<div className="space-y-6">
```

---

## 组件开发规范

### 命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| 组件文件 | kebab-case | `message-card.tsx` |
| 组件名 | PascalCase | `MessageCard` |
| 事件处理 | handle + 动作 | `handleReply` |
| Props 接口 | 组件名 + Props | `MessageCardProps` |
| 布尔 Props | is/has/can 前缀 | `isLoading` |

### 导出规范

- 页面组件：`export default`
- 其他组件：`export function`（禁止 default export）

---

## Server vs Client Components

| 功能 | 组件类型 |
|------|----------|
| 数据获取 | Server |
| 静态展示 | Server |
| 点击/输入交互 | Client |
| useState/useEffect | Client |
| 浏览器 API | Client |

---

## 后端规范

### API Schema 定义

```ts
// app/api/messages/schema.ts
import { z } from "zod"

export const MessageListReq = z.object({
  platform: z.enum(["twitter", "instagram", "tiktok"]).optional(),
  page: z.coerce.number().min(1).default(1),
  pageSize: z.coerce.number().min(1).max(100).default(20),
})

export const MessageItem = z.object({
  id: z.string(),
  content: z.string(),
  platform: z.string(),
})

export type MessageItemType = z.infer<typeof MessageItem>
```

**命名规范：** `{Resource}ListReq` / `{Resource}CreateReq` / `{Resource}UpdateReq` / `{Resource}Item` / `{Resource}ListResp`

### Route Handler 示例

```ts
// app/api/messages/route.ts
export async function GET(request: NextRequest) {
  const params = Object.fromEntries(request.nextUrl.searchParams)
  const parsed = MessageListReq.safeParse(params)

  if (!parsed.success) {
    return Response.json({ error: "Validation failed", details: parsed.error.flatten() }, { status: 400 })
  }

  const messages = await db.message.findMany({ ... })
  return Response.json({ data: messages })
}
```

### 响应格式统一

```ts
// 成功
return Response.json({ data: messages })
return Response.json({ data: newMessage }, { status: 201 })
return new Response(null, { status: 204 })

// 带分页
return Response.json({ data: messages, pagination: { page, pageSize, total } })

// 错误
return Response.json({ error: "Validation failed", details: [...] }, { status: 400 })
return Response.json({ error: "Not found" }, { status: 404 })
```

### redirect() 在 try-catch 中的处理

Next.js 的 `redirect()` 函数通过抛出特殊错误实现重定向。当在 `try-catch` 块中调用时，该错误会被捕获导致报错。**必须在 catch 中检查并重新抛出 redirect 错误**：

```ts
// ✅ 正确：检查并重新抛出 redirect 错误
try {
  await doSomething()
  return redirect("/success")
} catch (error) {
  // 检查 digest 属性判断是否为 redirect 错误
  if (
    error &&
    typeof error === "object" &&
    "digest" in error &&
    typeof (error as { digest?: string }).digest === "string" &&
    (error as { digest: string }).digest.includes("NEXT_REDIRECT")
  ) {
    throw error  // 重新抛出让 Next.js 处理
  }
  console.error("处理错误:", error)
  return redirect("/error")
}

// ❌ 错误：直接捕获所有错误
try {
  await doSomething()
  return redirect("/success")
} catch (error) {
  // redirect 错误也会被捕获，导致控制台报错
  console.error(error)
  return redirect("/error")
}
```

**背景**：`redirect()` 抛出的错误对象包含 `digest: "NEXT_REDIRECT;replace;/path;307;"` 属性。

### Server Actions 示例

```ts
// app/actions/message-actions.ts
"use server"

export async function sendReply(prevState: unknown, formData: FormData) {
  const result = replySchema.safeParse(Object.fromEntries(formData))
  if (!result.success) return { error: result.error.flatten().fieldErrors }

  await db.message.update({ where: { id: result.data.messageId }, data: { ... } })
  revalidatePath("/messages")
  return { success: true }
}
```

---

## 表单规范

使用 **react-hook-form + zod + shadcn Form**：

```tsx
const form = useForm<FormValues>({
  resolver: zodResolver(formSchema),
  defaultValues: { title: "", content: "" },
})

return (
  <Form {...form}>
    <form onSubmit={form.handleSubmit(handleSubmit)}>
      <FormField control={form.control} name="title" render={({ field }) => (
        <FormItem>
          <FormLabel>标题</FormLabel>
          <FormControl><Input {...field} /></FormControl>
          <FormMessage />
        </FormItem>
      )} />
    </form>
  </Form>
)
```

---

## 状态管理规范

| 场景 | 方案 |
|------|------|
| 组件内状态 | `useState` |
| 复杂组件状态 | `useReducer` |
| 跨组件共享 | React Context |
| 服务端数据 | Server Components + props |
| URL 状态 | `useSearchParams` / `useRouter` |

---

## Node.js 现代写法

| 使用 | 禁止 |
|------|------|
| `import { db } from "@/lib/db"` | `require()` / `module.exports` |
| `await fetch(url)` | `axios` / `node-fetch` |
| `crypto.randomUUID()` | `uuid` 库 |
| `structuredClone(obj)` | `JSON.parse(JSON.stringify())` |
| `arr.at(-1)` | `arr[arr.length - 1]` |
| `Object.hasOwn(obj, "key")` | `obj.hasOwnProperty()` |
| `fs/promises` | `fs.readFileSync` |

---

## 检查清单

### 前端

- [ ] 使用 shadcn/ui，无原生 HTML 交互元素
- [ ] 无硬编码颜色，样式全部使用 Tailwind class
- [ ] 品牌色使用 `text-brand-*`，无 inline style
- [ ] Dashboard 页面使用 `p-8` 内边距
- [ ] 图标统一 Lucide React
- [ ] 无 `any` 类型
- [ ] 非页面组件使用具名导出
- [ ] 使用 React 19 新特性，无废弃 API

### 后端

- [ ] 使用 App Router Route Handlers
- [ ] params 使用 `await context.params`
- [ ] API 模块包含 `schema.ts`
- [ ] 所有输入用 zod 验证
- [ ] 响应格式统一 `{ data }` / `{ error }`
- [ ] 使用 ES Modules，无 CommonJS

### 检查命令

```bash
npx tsc --noEmit                 # 类型检查
npm run lint                     # ESLint
grep -rE "forwardRef|defaultProps|getServerSideProps|require\(" --include="*.tsx" --include="*.ts" app/ components/ lib/
grep -rE "bg-\[#|text-\[#" --include="*.tsx" app/ components/
grep -rE "style=\{" --include="*.tsx" components/  # 检查 inline style
```
